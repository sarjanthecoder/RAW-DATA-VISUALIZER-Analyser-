// ===================================
// FILE UPLOAD HANDLING
// ===================================

const uploadForm = document.getElementById('uploadForm');
const fileInput = document.getElementById('fileInput');
const dropArea = document.getElementById('dropArea');
const fileInfo = document.getElementById('fileInfo');
const submitBtn = document.getElementById('submitBtn');
const loadingState = document.getElementById('loadingState');
const resultsSection = document.getElementById('results');

let selectedFile = null;

// Click to browse
dropArea.addEventListener('click', () => {
    fileInput.click();
});

// File input change
fileInput.addEventListener('change', (e) => {
    handleFile(e.target.files[0]);
});

// Drag and drop events
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

['dragenter', 'dragover'].forEach(eventName => {
    dropArea.addEventListener(eventName, () => {
        dropArea.classList.add('dragover');
    }, false);
});

['dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, () => {
        dropArea.classList.remove('dragover');
    }, false);
});

dropArea.addEventListener('drop', (e) => {
    const dt = e.dataTransfer;
    const files = dt.files;
    handleFile(files[0]);
}, false);

function handleFile(file) {
    if (!file) return;
    
    if (!file.name.endsWith('.csv')) {
        alert('Please upload a CSV file');
        return;
    }
    
    selectedFile = file;
    fileInfo.textContent = `Selected: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
    submitBtn.disabled = false;
}

// ===================================
// FORM SUBMISSION
// ===================================

uploadForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!selectedFile) {
        alert('Please select a file first');
        return;
    }
    
    // Show loading state
    uploadForm.style.display = 'none';
    loadingState.style.display = 'block';
    
    // Create form data
    const formData = new FormData();
    formData.append('file', selectedFile);
    
    try {
        // Send to backend
        const response = await fetch('http://localhost:5000/api/upload', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            displayResults(data.insights);
        } else {
            throw new Error(data.error || 'Failed to analyze data');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error analyzing file: ' + error.message);
        uploadForm.style.display = 'block';
        loadingState.style.display = 'none';
    }
});

// ===================================
// DISPLAY RESULTS
// ===================================

function displayResults(insights) {
    loadingState.style.display = 'none';
    resultsSection.style.display = 'block';
    
    // Scroll to results
    resultsSection.scrollIntoView({ behavior: 'smooth' });
    
    // Display summary stats
    displaySummaryStats(insights.summary);
    
    // Display charts
    displayCharts(insights.charts);
    
    // Display top items
    if (insights.top_items && insights.top_items.length > 0) {
        displayTopItems(insights.top_items);
    }
    
    // Display statistics
    if (insights.statistics && Object.keys(insights.statistics).length > 0) {
        displayStatistics(insights.statistics);
    }
}

function displaySummaryStats(summary) {
    const statsGrid = document.getElementById('statsGrid');
    statsGrid.innerHTML = '';
    
    // Display key metrics
    const metrics = [
        { label: 'Total Rows', value: summary.total_rows, icon: 'ðŸ“Š' },
        { label: 'Total Columns', value: summary.total_columns, icon: 'ðŸ“‹' },
    ];
    
    // Add any earnings/totals
    Object.keys(summary).forEach(key => {
        if (key.startsWith('total_') && key !== 'total_rows' && key !== 'total_columns') {
            const label = key.replace('total_', '').replace(/_/g, ' ').toUpperCase();
            metrics.push({
                label: `Total ${label}`,
                value: summary[key].toLocaleString('en-US', { 
                    style: 'currency', 
                    currency: 'USD' 
                }),
                icon: 'ðŸ’°'
            });
        }
        if (key.startsWith('average_')) {
            const label = key.replace('average_', '').replace(/_/g, ' ').toUpperCase();
            metrics.push({
                label: `Avg ${label}`,
                value: summary[key].toLocaleString('en-US', { 
                    style: 'currency', 
                    currency: 'USD' 
                }),
                icon: 'ðŸ“ˆ'
            });
        }
    });
    
    metrics.forEach((metric, index) => {
        const card = document.createElement('div');
        card.className = 'stat-card';
        card.style.animation = `fadeInUp 0.5s ease ${index * 0.1}s backwards`;
        card.innerHTML = `
            <div class="stat-value">${metric.value}</div>
            <div class="stat-label">${metric.label}</div>
        `;
        statsGrid.appendChild(card);
    });
}

function displayCharts(charts) {
    const chartsGrid = document.getElementById('chartsGrid');
    chartsGrid.innerHTML = '';
    
    if (!charts || Object.keys(charts).length === 0) return;
    
    const colorSchemes = [
        {
            background: 'rgba(102, 126, 234, 0.2)',
            border: 'rgb(102, 126, 234)'
        },
        {
            background: 'rgba(240, 147, 251, 0.2)',
            border: 'rgb(240, 147, 251)'
        },
        {
            background: 'rgba(79, 172, 254, 0.2)',
            border: 'rgb(79, 172, 254)'
        },
        {
            background: 'rgba(67, 233, 123, 0.2)',
            border: 'rgb(67, 233, 123)'
        }
    ];
    
    let colorIndex = 0;
    
    Object.keys(charts).forEach((chartKey, index) => {
        const chartData = charts[chartKey];
        const colors = colorSchemes[colorIndex % colorSchemes.length];
        colorIndex++;
        
        const container = document.createElement('div');
        container.className = 'chart-container';
        container.style.animation = `fadeInUp 0.5s ease ${index * 0.15}s backwards`;
        
        const canvas = document.createElement('canvas');
        canvas.id = `chart-${chartKey}`;
        
        container.innerHTML = `<h3 class="card-title">${chartData.title}</h3>`;
        container.appendChild(canvas);
        chartsGrid.appendChild(container);
        
        // Determine chart type
        let chartType = 'bar';
        if (chartKey.includes('timeline')) {
            chartType = 'line';
        } else if (chartKey.includes('distribution')) {
            chartType = 'bar';
        }
        
        // Create chart
        new Chart(canvas, {
            type: chartType,
            data: {
                labels: chartData.labels,
                datasets: [{
                    label: chartData.title,
                    data: chartData.data,
                    backgroundColor: colors.background,
                    borderColor: colors.border,
                    borderWidth: 2,
                    borderRadius: 8,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(15, 15, 35, 0.9)',
                        padding: 12,
                        borderColor: colors.border,
                        borderWidth: 1,
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        cornerRadius: 8
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: 'rgba(255, 255, 255, 0.7)'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: 'rgba(255, 255, 255, 0.7)',
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                }
            }
        });
    });
}

function displayTopItems(topItems) {
    const card = document.getElementById('topItemsCard');
    const container = document.getElementById('topItemsTable');
    
    card.style.display = 'block';
    card.style.animation = 'fadeInUp 0.5s ease';
    
    let html = '<table><thead><tr><th>Rank</th><th>Item</th><th>Count</th></tr></thead><tbody>';
    
    topItems.forEach((item, index) => {
        html += `
            <tr>
                <td><strong>#${index + 1}</strong></td>
                <td>${item.name}</td>
                <td>${item.count}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

function displayStatistics(statistics) {
    const card = document.getElementById('statisticsCard');
    const container = document.getElementById('statisticsTable');
    
    card.style.display = 'block';
    card.style.animation = 'fadeInUp 0.5s ease 0.2s backwards';
    
    let html = '<table><thead><tr><th>Column</th><th>Min</th><th>Max</th><th>Mean</th><th>Median</th><th>Std Dev</th></tr></thead><tbody>';
    
    Object.keys(statistics).forEach(column => {
        const stats = statistics[column];
        html += `
            <tr>
                <td><strong>${column}</strong></td>
                <td>${stats.min.toFixed(2)}</td>
                <td>${stats.max.toFixed(2)}</td>
                <td>${stats.mean.toFixed(2)}</td>
                <td>${stats.median.toFixed(2)}</td>
                <td>${stats.std.toFixed(2)}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

// ===================================
// SMOOTH SCROLL FOR NAVIGATION
// ===================================

document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
            target.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
            
            // Update active nav link
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            this.classList.add('active');
        }
    });
});

// ===================================
// ANIMATIONS
// ===================================

// Add CSS for fade in up animation
const style = document.createElement('style');
style.textContent = `
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    rootMargin: '0px 0px -50px 0px'
};

const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            entry.target.style.animation = 'fadeInUp 0.6s ease forwards';
        }
    });
}, observerOptions);

// Observe feature cards
document.querySelectorAll('.feature-card').forEach(card => {
    observer.observe(card);
});

console.log('ðŸš€ Data Insights Pro - Ready!');
